// ============================================
// INVENTORY TRANSACTION ENUMS
// ============================================
enum InvTransType {
  GOODS_RECEIPT // Nhập kho
  GOODS_ISSUE // Xuất kho
  STOCK_TRANSFER // Chuyển kho
  ADJUSTMENT // Điều chỉnh
}

enum InvTransStatus {
  DRAFT
  COMPLETED
  CANCELLED
}

enum InventoryAdjustDirection {
  INCREASE
  DECREASE
  BOTH
}


// ============================================
// HEADER - Phiếu xuất/nhập/chuyển kho
// ============================================
model InvTransHeader {
  id       Int            @id @default(autoincrement())
  publicId String         @unique @default(ulid()) @db.Char(26)
  transNum String         @unique @db.VarChar(50)
  type     InvTransType
  status   InvTransStatus @default(DRAFT)

  // Warehouse references
  fromWarehouseId Int? // Required for GOODS_ISSUE, STOCK_TRANSFER
  toWarehouseId   Int? // Required for GOODS_RECEIPT, STOCK_TRANSFER

  // Reference to source document (optional)
  referenceType String? @db.VarChar(10) // 'PO', 'SO'
  referenceId   Int?
  referenceNum  String? @db.VarChar(50)

  // For ADJUSTMENT type
  
  reasonId Int?
  // Metadata
  transactionDate DateTime @default(now())
  note            String?  @db.VarChar(500)
  createdBy       String   @db.VarChar(100)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  fromWarehouse Warehouse?     @relation("InvTransFrom", fields: [fromWarehouseId], references: [id])
  toWarehouse   Warehouse?     @relation("InvTransTo", fields: [toWarehouseId], references: [id])
  reason    InventoryAdjustReason? @relation(fields: [reasonId], references: [id])
  lines         InvTransLine[]

  @@index([transNum])
  @@index([type])
  @@index([status])
  @@index([transactionDate])
  @@index([fromWarehouseId])
  @@index([toWarehouseId])
  @@index([referenceType, referenceId])
}

// ============================================
// LINE - Chi tiết từng SKU
// ============================================
model InvTransLine {
  id       Int    @id @default(autoincrement())
  publicId String @unique @default(ulid()) @db.Char(26)
  headerId Int
  lineNum  Int

  // Item details
  itemSkuId Int
  quantity  Decimal @db.Decimal(18, 4)
  uomCode   String  @db.VarChar(10)
  toBaseFactor Decimal @default(1) @db.Decimal(10, 4)
  baseQty      Decimal @default(0) @db.Decimal(18, 4)
  baseUomCode   String @db.VarChar(10)

  // Line-level note
  note      String?  @db.VarChar(500)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  header  InvTransHeader @relation(fields: [headerId], references: [id], onDelete: Cascade)
  itemSku ItemSKU        @relation(fields: [itemSkuId], references: [id])
  uom     UOM            @relation("invTransLineUoms", fields: [uomCode], references: [code])
  baseUom UOM            @relation("invTransLineBaseUoms", fields: [baseUomCode], references: [code])

  @@unique([headerId, lineNum])
  @@index([headerId])
  @@index([itemSkuId])
  //uoms UOM[] @relation("invTransLineUoms")
  //uoms UOM[] @relation("invTransLineBaseUoms")
}

model InventoryAdjustReason {
  id               Int   @id @default(autoincrement())
  
  code             String   @unique @db.VarChar(30)
  name             String   @db.VarChar(255)
  description      String?

  direction        InventoryAdjustDirection

  affectCost       Boolean  @default(true)
  requireNote      Boolean  @default(false)
  requireApproval  Boolean  @default(false)

  isActive         Boolean  @default(true)

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  trans InvTransHeader[]
}

