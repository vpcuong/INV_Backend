// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  name      String?
  role      String   @default("user") // user, admin, manager
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ItemCategory {
  id          Int       @id @default(autoincrement())
  name        String
  description String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  items Item[]
}

model ItemType {
  id          Int       @id @default(autoincrement())
  code        String?
  name        String
  description String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  items Item[]
}

model Item {
  id          Int             @id @default(autoincrement())
  name        String
  categoryId  Int
  itemTypeId  Int
  materialId  Int?        // chất liệu
  model       String?         // model sản phẩm
  uomId       Int?            // đơn vị tính
  costPrice   Float?          // đơn giá mua
  sellingPrice Float?         // đơn giá bán

  // Dimension (chỉ dùng nếu hasSku = false)
  lengthCm    Float?
  widthCm     Float?
  heightCm    Float?
  weightG     Float?

  notes       String?
  status      String?         // Active / Inactive / Draft
  hasSku      Boolean         @default(false)
  isPurchasable Boolean @default(false)
  isSellable Boolean @default(false)
  isManufactured Boolean @default(false)

  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  category    ItemCategory    @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  itemType    ItemType        @relation(fields: [itemTypeId], references: [id], onDelete: Restrict)
  revisions   ItemRevision[] 
  material    Material? @relation(fields: [materialId], references: [id], onDelete: SetNull)
  uom         UOM? @relation(fields: [uomId], references: [id], onDelete: SetNull)
  supplierItems SupplierItem[]
}

model ItemRevision {
  id          Int       @id @default(autoincrement())
  itemId      Int
  revision    String
  name        String?
  notes       String?
  status      String?     // Draft / Pending / Approved
  effectiveAt DateTime?   // Ngày hiệu lực phiên bản BOM

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  item        Item        @relation(fields: [itemId], references: [id], onDelete: Cascade)
  skus        ItemSKU[]
}

model ItemSKU {
  id          Int        @id @default(autoincrement())
  skuCode     String     @unique
  revisionId  Int

  // Variant attributes
  colorId     Int
  genderId    Int     // Men/Women/Unisex – vì ảnh hưởng BOM
  sizeId      Int
  pattern     String?

  costPrice   Float?  @default(0)        // đơn giá mua
  sellingPrice Float?  @default(0)       // đơn giá bán

  // Dimensions (áp dụng cho SKU của sản phẩm có SKU)
  lengthCm    Float?
  widthCm     Float?
  heightCm    Float?
  weightG     Float?

  notes       String?
  status      String?     // Active/Inactive

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  revision    ItemRevision @relation(fields: [revisionId], references: [id], onDelete: Cascade)
  color       Color @relation(fields: [colorId], references: [id], onDelete: Restrict)
  gender      Gender @relation(fields: [genderId], references: [id], onDelete: Restrict)
  size        Size @relation(fields: [sizeId], references: [id], onDelete: Restrict)
}

model Color {
  id         Int        @id @default(autoincrement())
  code       String     @unique @db.VarChar(20)     // BLK, RED, BLUE…
  desc       String     @db.VarChar(100)
  hexValue   String?    @db.Char(7)                 // optional: #FFFFFF
  status     Boolean    @default(true)
  sortOrder  Int?       

  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  createdBy  String?    @db.VarChar(50)

  itemSKU    ItemSKU[]
}


model Gender {
  id         Int        @id @default(autoincrement())
  code       String     @unique @db.VarChar(20)     // M, F, UNISEX…
  desc       String     @db.VarChar(100)
  status     Boolean    @default(true)
  sortOrder  Int?       

  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  createdBy  String?    @db.VarChar(50)

  itemSKU    ItemSKU[]
}


model Size {
  id         Int        @id @default(autoincrement())
  code       String     @unique @db.VarChar(20)     // XS, S, M, L, XL…
  desc       String     @db.VarChar(100)
  status     Boolean    @default(true)
  sortOrder  Int?       

  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  createdBy  String?    @db.VarChar(50)

  itemSKU    ItemSKU[]
}

model Material {
  id         Int        @id @default(autoincrement())
  code       String     @unique @db.VarChar(20)  
  desc       String     @db.VarChar(100)
  status     Boolean    @default(true)
  sortOrder  Int?       

  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  createdBy  String?    @db.VarChar(50)

  item    Item[]
}

model UOMClass {
  id         Int      @id @default(autoincrement())
  code       String   @unique
  name       String
  description String?
  sortOrder  Int      @default(0)
  isActive   Boolean  @default(true)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  createdBy  String?

  uoms       UOM[]
}

model UOM {
  id         Int      @id @default(autoincrement())
  code       String   @unique
  name       String
  description String?
  sortOrder  Int      @default(0)
  isActive   Boolean  @default(true)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  createdBy  String?

  classId    Int
  uomClass   UOMClass @relation(fields: [classId], references: [id])

  fromConversions UOMConversion[] @relation("FromUOM")
  toConversions   UOMConversion[] @relation("ToUOM")
  items           Item[]
  supplierItemPackages SupplierItemPackaging[]
}

model UOMConversion {
  id         Int      @id @default(autoincrement())
  
  fromUOMId  Int
  toUOMId    Int
  factor     Float     // ví dụ: 1 M = 100 CM → factor = 100

  isActive   Boolean   @default(true)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  createdBy  String?

  fromUOM    UOM @relation("FromUOM", fields: [fromUOMId], references: [id])
  toUOM      UOM @relation("ToUOM", fields: [toUOMId], references: [id])
}

model Supplier {
  id              Int                @id @default(autoincrement())
  code            String             @unique
  name            String
  
  // Thông tin liên hệ
  phone           String?
  email           String?
  website         String?
  
  // Địa chỉ
  address         String?
  city            String?
  province        String?
  country         String?
  postalCode      String?
  
  // Thông tin kinh doanh
  taxId           String?            // Mã số thuế
  contactPerson   String?            // Người liên hệ
  paymentTerms    String?            // Điều khoản thanh toán (e.g., "NET30", "NET60")
  
  // Trạng thái & phân loại
  status          String?            // Active / Inactive / Blacklist
  category        String?            // e.g., "Fabric", "Accessories", "Packaging"
  rating          Float?             // Đánh giá (0-5)
  
  isActive        Boolean            @default(true)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  createdBy       String?
  sortOrder       Int                @default(0)

  supplierItems SupplierItem[]
}

model SupplierItem {
  id             Int      @id @default(autoincrement())

  supplierId     Int
  itemId         Int

  supplierItemCode String?        // Mã hàng theo NCC (nếu có)
  currency        String?         // VND, USD,...
  unitPrice       Decimal?        // Giá theo đơn vị base hoặc theo 1 cấp đóng gói nào đó

  leadTimeDays    Int?            // Thời gian giao hàng dự kiến
  isActive        Boolean @default(true)

  supplier        Supplier @relation(fields: [supplierId], references: [id])
  item            Item     @relation(fields: [itemId], references: [id])

  packagings      SupplierItemPackaging[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([supplierId, itemId])  // 1 NCC – 1 Item: 1 dòng
}

model SupplierItemPackaging {
  id             Int      @id @default(autoincrement())

  supplierItemId Int
  level          Int      // 1 = cấp nhỏ hơn base hoặc cấp gần base nhất
                         // 2 = cấp lớn hơn level 1 (outer pack)
                         // 3 = lớn hơn nữa,... (CTN,...)

  uomId          Int      // BAG / BOX / CTN,...
  uom            UOM      @relation(fields: [uomId], references: [id])

  /// Số lượng "cấp ngay trước" nằm trong 1 đơn vị packaging này.
  /// - Nếu level = 1: qtyPerPrevLevel = số EA trong 1 đơn vị này (vì "prev" = base UOM).
  /// - Nếu level = 2: qtyPerPrevLevel = số cấp 1 trong 1 đơn vị level 2.
  /// - Nếu level = 3: qtyPerPrevLevel = số cấp 2 trong 1 đơn vị level 3, v.v.
  qtyPerPrevLevel Int

  /// Giá trị pre-calculated: số EA trong 1 đơn vị packaging này
  /// (có thể compute bằng code rồi lưu, hoặc để null và tính runtime).
  qtyToBase       Int?

  supplierItem    SupplierItem @relation(fields: [supplierItemId], references: [id])

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([supplierItemId, level]) // 1 NCC–Item, mỗi level chỉ 1 dòng
}


